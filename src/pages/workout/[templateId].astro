---
import BaseLayout from "../../layouts/BaseLayout.astro";
import NavigationHeader from "../../components/navigation/NavigationHeader.astro";
import { WorkoutForm } from "../../components/workout/WorkoutForm";
import { DEFAULT_USER_ID, supabaseClient } from "../../db/supabase.client";
import { WorkoutService } from "../../lib/services/workout.service";
import type { WorkoutPrefillResponseDTO } from "../../types";

export const prerender = false;

const { templateId } = Astro.params;

if (!templateId) {
  return Astro.redirect("/templates");
}

let prefillData: WorkoutPrefillResponseDTO | null = null;
let error: string | null = null;

try {
  prefillData = await WorkoutService.getPrefillData(supabaseClient, templateId, DEFAULT_USER_ID);
} catch (err) {
  console.error("Error fetching prefill data:", err);
  if (err instanceof Error && err.message === "Template not found") {
    error = "Template not found";
  } else {
    error = "Failed to load workout data";
  }
}
---

<BaseLayout title={prefillData ? `Workout: ${prefillData.template_name}` : "Workout"}>
  <NavigationHeader currentPath="/templates" slot="nav" />
  
  {error ? (
    <div class="container mx-auto px-4 py-8">
      <div class="max-w-md mx-auto text-center">
        <h1 class="text-2xl font-bold text-red-600 mb-4">Error</h1>
        <p class="text-gray-700 mb-6">{error}</p>
        <a 
          href="/templates" 
          class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          Back to Templates
        </a>
      </div>
    </div>
  ) : prefillData ? (
    <WorkoutForm prefill={prefillData} client:load />
  ) : null}
</BaseLayout>
